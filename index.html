<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Manager Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a1929 0%, #1a2332 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8f 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            color: #ffffff;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            color: #b3d4f7;
            font-size: 14px;
        }

        .nav-tabs {
            display: flex;
            overflow-x: auto;
            background: #162a3f;
            padding: 10px 5px;
            gap: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .nav-tabs::-webkit-scrollbar {
            height: 3px;
        }

        .nav-tabs::-webkit-scrollbar-thumb {
            background: #2d5a8f;
            border-radius: 3px;
        }

        .tab-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px 15px;
            background: #1e3a5f;
            border: none;
            color: #b3d4f7;
            cursor: pointer;
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #2d5a8f 0%, #3a7bc8 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(45, 90, 143, 0.4);
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: linear-gradient(135deg, #1a2f45 0%, #233a52 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .card h2 {
            color: #4a9eff;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #2d5a8f;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #b3d4f7;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: #0f1e2e;
            border: 2px solid #2d5a8f;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4a9eff;
            box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2d5a8f 0%, #3a7bc8 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(45, 90, 143, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #1e7e34 0%, #28a745 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #bd2130 0%, #dc3545 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #e0a800 0%, #ffc107 100%);
            color: #000;
        }

        .barcode-preview {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
            overflow-x: auto;
            max-width: 100%;
        }

        .barcode-preview svg {
            max-width: 100%;
            height: auto;
        }

        .product-card {
            background: linear-gradient(135deg, #1a2f45 0%, #233a52 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #2d5a8f;
            transition: all 0.3s;
        }

        .product-card:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .product-card.sold {
            border-left-color: #28a745;
            opacity: 0.8;
        }

        .product-card.out-of-stock {
            border-left-color: #dc3545;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .product-title {
            font-size: 16px;
            font-weight: bold;
            color: #4a9eff;
        }

        .product-price {
            font-size: 18px;
            color: #28a745;
            font-weight: bold;
        }

        .product-details {
            font-size: 13px;
            color: #b3d4f7;
            margin: 5px 0;
        }

        .product-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2d5a8f 0%, #1e3a5f 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #4a9eff;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #b3d4f7;
            text-transform: uppercase;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            background: #0f1e2e;
            border: 2px solid #2d5a8f;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
        }

        #reader {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin: 15px 0;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c8ba3;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #000;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a2f45 0%, #233a52 100%);
            border-radius: 12px;
            padding: 25px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .receipt-container {
            background: white;
            color: #000;
            padding: 30px;
            border-radius: 8px;
            max-width: 400px;
            margin: 0 auto;
            font-family: 'Courier New', monospace;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #000;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .receipt-header h2 {
            margin: 0;
            font-size: 24px;
            color: #000;
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }

        .receipt-footer {
            border-top: 2px dashed #000;
            padding-top: 15px;
            margin-top: 15px;
            text-align: center;
            font-size: 12px;
        }

        .receipt-total {
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .receipt-container, .receipt-container * {
                visibility: visible;
            }
            .receipt-container {
                position: absolute;
                left: 0;
                top: 0;
            }
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: #1e3a5f;
            border: 2px solid #2d5a8f;
            border-radius: 6px;
            color: #b3d4f7;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #2d5a8f;
            color: white;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 20px;
            }
            
            .tab-btn {
                font-size: 12px;
                padding: 10px 12px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì¶ Inventory Manager Pro</h1>
        <p>Complete Business Solution</p>
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
        <button class="tab-btn" onclick="switchTab('generate')">üè∑Ô∏è Generate</button>
        <button class="tab-btn" onclick="switchTab('scan')">üì∑ Scan</button>
        <button class="tab-btn" onclick="switchTab('stock')">üì¶ Stock</button>
        <button class="tab-btn" onclick="switchTab('sold')">‚úÖ Sold</button>
        <button class="tab-btn" onclick="switchTab('outofstock')">‚ùå Out of Stock</button>
        <button class="tab-btn" onclick="switchTab('receipts')">üìÑ Receipts</button>
        <button class="tab-btn" onclick="switchTab('analytics')">üìà Analytics</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalProducts">0</div>
                <div class="stat-label">Total Products</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="availableStock">0</div>
                <div class="stat-label">Available</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="soldItems">0</div>
                <div class="stat-label">Sold</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="outOfStockItems">0</div>
                <div class="stat-label">Out of Stock</div>
            </div>
        </div>

        <div class="card">
            <h2>üìã Recent Activity</h2>
            <div id="recentActivity"></div>
        </div>
    </div>

    <!-- Generate Barcode Tab -->
    <div id="generate" class="tab-content">
        <div class="card">
            <h2>üè∑Ô∏è Generate New Barcode</h2>
            <form id="generateForm">
                <div class="form-group">
                    <label>Product Name / Model Name</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>Model Number</label>
                    <input type="text" id="modelNumber" required>
                </div>
                <div class="form-group">
                    <label>Brand Name</label>
                    <input type="text" id="brandName" required>
                </div>
                <div class="form-group">
                    <label>Price (PKR)</label>
                    <input type="number" id="price" required min="0">
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="quantity" value="1" min="1" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="category">
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Food">Food</option>
                        <option value="Books">Books</option>
                        <option value="Furniture">Furniture</option>
                        <option value="Others">Others</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <input type="text" id="description">
                </div>
                <button type="submit" class="btn btn-primary">Generate Barcode</button>
            </form>
        </div>

        <div class="card" id="barcodePreviewCard" style="display: none;">
            <h2>üì± Barcode Preview</h2>
            <div class="barcode-preview">
                <svg id="barcodePreview"></svg>
                <div style="margin-top: 15px; color: #333;">
                    <strong id="previewProductName"></strong><br>
                    <span id="previewDetails"></span>
                </div>
            </div>
            <button class="btn btn-success" onclick="saveProduct()">Save to Inventory</button>
            <button class="btn btn-primary" onclick="downloadBarcode()">Download Barcode</button>
        </div>
    </div>

    <!-- Scan Barcode Tab -->
    <div id="scan" class="tab-content">
        <div class="card">
            <h2>üì∑ Scan Barcode</h2>
            <div id="reader"></div>
            <button class="btn btn-primary" onclick="startScanner()">Start Scanner</button>
            <button class="btn btn-danger" onclick="stopScanner()">Stop Scanner</button>
        </div>

        <div class="card">
            <h2>üîç Manual Search</h2>
            <div class="form-group">
                <label>Enter Barcode Number</label>
                <input type="text" id="manualBarcode" placeholder="Enter barcode...">
            </div>
            <button class="btn btn-primary" onclick="searchBarcode()">Search</button>
        </div>

        <div class="card" id="scannedProductCard" style="display: none;">
            <h2>üì¶ Product Details</h2>
            <div id="scannedProductDetails"></div>
        </div>
    </div>

    <!-- Available Stock Tab -->
    <div id="stock" class="tab-content">
        <div class="card">
            <h2>üì¶ Available Stock</h2>
            <div class="search-box">
                <input type="text" id="stockSearch" placeholder="üîç Search products..." oninput="filterProducts('stock')">
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterByCategory('stock', 'all')">All</button>
                <button class="filter-btn" onclick="filterByCategory('stock', 'Electronics')">Electronics</button>
                <button class="filter-btn" onclick="filterByCategory('stock', 'Clothing')">Clothing</button>
                <button class="filter-btn" onclick="filterByCategory('stock', 'Food')">Food</button>
                <button class="filter-btn" onclick="filterByCategory('stock', 'Others')">Others</button>
            </div>
            <div id="stockList"></div>
        </div>
    </div>

    <!-- Sold Items Tab -->
    <div id="sold" class="tab-content">
        <div class="card">
            <h2>‚úÖ Sold Items</h2>
            <div class="search-box">
                <input type="text" id="soldSearch" placeholder="üîç Search sold items..." oninput="filterProducts('sold')">
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterByDate('sold', 'all')">All Time</button>
                <button class="filter-btn" onclick="filterByDate('sold', 'today')">Today</button>
                <button class="filter-btn" onclick="filterByDate('sold', 'week')">This Week</button>
                <button class="filter-btn" onclick="filterByDate('sold', 'month')">This Month</button>
            </div>
            <div id="soldList"></div>
        </div>
    </div>

    <!-- Out of Stock Tab -->
    <div id="outofstock" class="tab-content">
        <div class="card">
            <h2>‚ùå Out of Stock Items</h2>
            <div class="search-box">
                <input type="text" id="outofstockSearch" placeholder="üîç Search out of stock..." oninput="filterProducts('outofstock')">
            </div>
            <div id="outofstockList"></div>
        </div>
    </div>

    <!-- Created Receipts Tab -->
    <div id="receipts" class="tab-content">
        <div class="card">
            <h2>üìÑ Created Receipts</h2>
            <div class="search-box">
                <input type="text" id="receiptsSearch" placeholder="üîç Search by receipt number, customer name, or product..." oninput="filterReceipts()">
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterReceiptsByDate('all')">All Time</button>
                <button class="filter-btn" onclick="filterReceiptsByDate('today')">Today</button>
                <button class="filter-btn" onclick="filterReceiptsByDate('week')">This Week</button>
                <button class="filter-btn" onclick="filterReceiptsByDate('month')">This Month</button>
            </div>
            <div id="receiptsList"></div>
        </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics" class="tab-content">
        <div class="card">
            <h2>üéØ Quick Actions</h2>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="switchTab('generate')">Generate Barcode</button>
                <button class="btn btn-success" onclick="switchTab('scan')">Scan Barcode</button>
                <button class="btn btn-warning" onclick="exportData()">Export Data</button>
                <button class="btn btn-danger" onclick="importData()">Import Data</button>
                <button class="btn btn-danger" onclick="resetApp()" style="background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);">üîÑ Reset App</button>
            </div>
        </div>

        <div class="card">
            <h2>üìà Sales Analytics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">0</div>
                    <div class="stat-label">Total Revenue (PKR)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todaySales">0</div>
                    <div class="stat-label">Today's Sales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="weekSales">0</div>
                    <div class="stat-label">This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="monthSales">0</div>
                    <div class="stat-label">This Month</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üèÜ Top Selling Products</h2>
            <div id="topProducts"></div>
        </div>

        <div class="card">
            <h2>üìä Category Distribution</h2>
            <div id="categoryStats"></div>
        </div>
    </div>

    <!-- Modal for Product Details -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <h2>Product Details</h2>
            <div id="modalProductDetails"></div>
            <button class="btn btn-danger" onclick="closeModal()">Close</button>
        </div>
    </div>

    <!-- Modal for Product Details -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <h2>Product Details</h2>
            <div id="modalProductDetails"></div>
            <button class="btn btn-danger" onclick="closeModal()">Close</button>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <h2>üìÑ Generate Receipt</h2>
            <div class="card">
                <form id="receiptForm">
                    <div class="form-group">
                        <label>Receipt Number (Optional)</label>
                        <input type="text" id="receiptNumber" placeholder="Auto-generated if empty">
                    </div>
                    <div class="form-group">
                        <label>Customer Name *</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label>Customer Phone (Optional)</label>
                        <input type="tel" id="customerPhone">
                    </div>
                    <div class="form-group">
                        <label>Customer Address (Optional)</label>
                        <input type="text" id="customerAddress">
                    </div>
                    <div class="form-group">
                        <label>Payment Method (Optional)</label>
                        <select id="paymentMethod">
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Online">Online</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <input type="text" id="receiptNotes">
                    </div>
                    <button type="submit" class="btn btn-success">üìÑ Generate Receipt</button>
                    <button type="button" class="btn btn-danger" onclick="closeReceiptModal()">Cancel</button>
                </form>
            </div>
            
            <div id="receiptPreview" style="display: none;">
                <div class="receipt-container" id="receiptContent">
                    <!-- Receipt will be generated here -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="printReceipt()">üñ®Ô∏è Print Receipt</button>
                    <button class="btn btn-success" onclick="downloadReceipt()">üíæ Download PDF</button>
                    <button class="btn btn-warning" onclick="resetReceiptForm()">üîÑ New Receipt</button>
                    <button class="btn btn-danger" onclick="closeReceiptModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize data structure
        let inventory = {
            products: [],
            soldItems: [],
            receipts: [],
            currentBarcode: null
        };

        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('inventoryData');
            if (saved) {
                inventory = JSON.parse(saved);
                // Ensure receipts array exists for backward compatibility
                if (!inventory.receipts) {
                    inventory.receipts = [];
                }
            }
            updateDashboard();
            renderAllLists();
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('inventoryData', JSON.stringify(inventory));
            updateDashboard();
        }

        // Generate unique barcode
        function generateUniqueBarcode() {
            return 'BAR' + Date.now() + Math.floor(Math.random() * 1000);
        }

        // Handle barcode generation form
        document.getElementById('generateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productData = {
                barcode: generateUniqueBarcode(),
                productName: document.getElementById('productName').value,
                modelNumber: document.getElementById('modelNumber').value,
                brandName: document.getElementById('brandName').value,
                price: parseFloat(document.getElementById('price').value),
                quantity: parseInt(document.getElementById('quantity').value),
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                dateAdded: new Date().toISOString(),
                status: 'available'
            };

            inventory.currentBarcode = productData;

            // Generate barcode image
            JsBarcode("#barcodePreview", productData.barcode, {
                format: "CODE128",
                width: 2,
                height: 100,
                displayValue: true
            });

            document.getElementById('previewProductName').textContent = productData.productName;
            document.getElementById('previewDetails').textContent = 
                `${productData.brandName} - ${productData.modelNumber} | PKR ${productData.price}`;
            
            document.getElementById('barcodePreviewCard').style.display = 'block';
        });

        // Save product to inventory
        function saveProduct() {
            if (!inventory.currentBarcode) return;
            
            inventory.products.push(inventory.currentBarcode);
            saveData();
            
            alert('‚úÖ Product added to inventory successfully!');
            document.getElementById('generateForm').reset();
            document.getElementById('barcodePreviewCard').style.display = 'none';
            inventory.currentBarcode = null;
            
            renderAllLists();
        }

        // Download barcode as image
        function downloadBarcode() {
            const svg = document.getElementById('barcodePreview');
            const svgData = new XMLSerializer().serializeToString(svg);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                
                const link = document.createElement('a');
                link.download = `barcode_${inventory.currentBarcode.barcode}.png`;
                link.href = canvas.toDataURL();
                link.click();
            };
            
            img.src = 'data:image/svg+xml;base64,' + btoa(svgData);
        }

        // Scanner functionality
        let html5QrCode = null;

        function startScanner() {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }

            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                onScanSuccess,
                onScanError
            ).catch(err => {
                alert('Unable to start camera. Please check permissions.');
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode = null;
                });
            }
        }

        function onScanSuccess(decodedText) {
            stopScanner();
            displayScannedProduct(decodedText);
        }

        function onScanError(error) {
            // Silent error handling
        }

        function searchBarcode() {
            const barcode = document.getElementById('manualBarcode').value.trim();
            if (barcode) {
                displayScannedProduct(barcode);
            }
        }

        function displayScannedProduct(barcode) {
            const product = inventory.products.find(p => p.barcode === barcode && p.status === 'available');
            
            if (product) {
                const card = document.getElementById('scannedProductCard');
                const details = document.getElementById('scannedProductDetails');
                
                details.innerHTML = `
                    <div class="product-card">
                        <div class="product-header">
                            <div class="product-title">${product.productName}</div>
                            <div class="product-price">PKR ${product.price}</div>
                        </div>
                        <div class="product-details">
                            <strong>Brand:</strong> ${product.brandName}<br>
                            <strong>Model:</strong> ${product.modelNumber}<br>
                            <strong>Barcode:</strong> ${product.barcode}<br>
                            <strong>Category:</strong> ${product.category}<br>
                            <strong>Quantity:</strong> ${product.quantity}<br>
                            ${product.description ? `<strong>Description:</strong> ${product.description}<br>` : ''}
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-success" onclick="sellProduct('${product.barcode}')">üí∞ Sell Product</button>
                            <button class="btn btn-primary" onclick="openReceiptModal('${product.barcode}')">üìÑ Generate Receipt</button>
                            <button class="btn btn-warning" onclick="editProduct('${product.barcode}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-primary" onclick="viewProductDetails('${product.barcode}')">üëÅÔ∏è View Details</button>
                        </div>
                    </div>
                `;
                
                card.style.display = 'block';
            } else {
                alert('‚ùå Product not found or already sold!');
            }
        }

        function sellProduct(barcode) {
            const productIndex = inventory.products.findIndex(p => p.barcode === barcode && p.status === 'available');
            
            if (productIndex !== -1) {
                const product = inventory.products[productIndex];
                
                if (product.quantity > 1) {
                    // Create a sold item entry even when reducing quantity
                    const soldProduct = {
                        ...product,
                        quantity: 1,
                        soldDate: new Date().toISOString(),
                        soldDay: new Date().toLocaleDateString('en-US', { weekday: 'long' }),
                        soldTime: new Date().toLocaleTimeString(),
                        status: 'sold'
                    };
                    inventory.soldItems.push(soldProduct);
                    
                    // Reduce quantity in main inventory
                    product.quantity -= 1;
                } else {
                    // Last item - mark as sold and move to sold items
                    product.status = 'sold';
                    const soldProduct = {
                        ...product,
                        soldDate: new Date().toISOString(),
                        soldDay: new Date().toLocaleDateString('en-US', { weekday: 'long' }),
                        soldTime: new Date().toLocaleTimeString()
                    };
                    inventory.soldItems.push(soldProduct);
                }
                
                saveData();
                alert('‚úÖ Product sold successfully!');
                document.getElementById('scannedProductCard').style.display = 'none';
                document.getElementById('manualBarcode').value = '';
                renderAllLists();
                updateDashboard();
            }
        }

        function markOutOfStock(barcode) {
            const product = inventory.products.find(p => p.barcode === barcode);
            if (product) {
                product.status = 'outofstock';
                product.outOfStockDate = new Date().toISOString();
                saveData();
                renderAllLists();
                alert('‚úÖ Product marked as out of stock');
            }
        }

        function restockProduct(barcode) {
            const quantity = prompt('Enter quantity to restock:');
            if (quantity && !isNaN(quantity)) {
                const product = inventory.products.find(p => p.barcode === barcode);
                if (product) {
                    product.quantity = (product.quantity || 0) + parseInt(quantity);
                    product.status = 'available';
                    saveData();
                    renderAllLists();
                    alert('‚úÖ Product restocked successfully!');
                }
            }
        }

        function deleteProduct(barcode) {
            if (confirm('Are you sure you want to delete this product?')) {
                inventory.products = inventory.products.filter(p => p.barcode !== barcode);
                saveData();
                renderAllLists();
                alert('‚úÖ Product deleted successfully');
            }
        }

        function viewSoldProductDetails(barcode, soldDate) {
            const product = inventory.soldItems.find(p => p.barcode === barcode && p.soldDate === soldDate);
            
            if (product) {
                const modal = document.getElementById('productModal');
                const details = document.getElementById('modalProductDetails');
                
                // Format dates
                const addedDate = new Date(product.dateAdded);
                const soldDateObj = new Date(product.soldDate);
                const soldDay = soldDateObj.toLocaleDateString('en-US', { weekday: 'long' });
                const soldDateNum = soldDateObj.getDate();
                const soldMonth = soldDateObj.getMonth() + 1;
                const soldYear = soldDateObj.getFullYear();
                const formattedSoldDate = `${soldDay} ${soldDateNum}/${soldMonth}/${soldYear}`;
                
                details.innerHTML = `
                    <div class="product-card">
                        <h3>${product.productName}</h3>
                        <p><strong>Barcode:</strong> ${product.barcode}</p>
                        <p><strong>Brand:</strong> ${product.brandName}</p>
                        <p><strong>Model Number:</strong> ${product.modelNumber}</p>
                        <p><strong>Price:</strong> PKR ${product.price}</p>
                        <p><strong>Quantity:</strong> ${product.quantity}</p>
                        <p><strong>Category:</strong> ${product.category}</p>
                        ${product.description ? `<p><strong>Description:</strong> ${product.description}</p>` : ''}
                        <p><strong>Date Added:</strong> ${addedDate.toLocaleString()}</p>
                        <p><strong>Sold Date:</strong> ${formattedSoldDate}</p>
                        <p><strong>Sold Time:</strong> ${product.soldTime}</p>
                        <p><strong>Status:</strong> <span class="badge badge-success">SOLD</span></p>
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #2d5a8f;">
                            <button class="btn btn-danger" onclick="deleteSoldProduct('${product.barcode}', '${product.soldDate}')" style="width: 100%;">
                                üóëÔ∏è Delete This Product from Sold Section
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.add('active');
            }
        }

        function deleteSoldProduct(barcode, soldDate) {
            if (confirm('‚ö†Ô∏è Are you sure you want to delete this sold product?\n\nThis action cannot be undone!')) {
                // Find and remove the sold product
                const index = inventory.soldItems.findIndex(p => p.barcode === barcode && p.soldDate === soldDate);
                
                if (index !== -1) {
                    inventory.soldItems.splice(index, 1);
                    saveData();
                    renderAllLists();
                    closeModal();
                    alert('‚úÖ Sold product deleted successfully!');
                } else {
                    alert('‚ùå Product not found!');
                }
            }
        }

        function viewProductDetails(barcode) {
            const product = inventory.products.find(p => p.barcode === barcode) || 
                          inventory.soldItems.find(p => p.barcode === barcode);
            
            if (product) {
                const modal = document.getElementById('productModal');
                const details = document.getElementById('modalProductDetails');
                
                details.innerHTML = `
                    <div class="product-card">
                        <h3>${product.productName}</h3>
                        <p><strong>Barcode:</strong> ${product.barcode}</p>
                        <p><strong>Brand:</strong> ${product.brandName}</p>
                        <p><strong>Model Number:</strong> ${product.modelNumber}</p>
                        <p><strong>Price:</strong> PKR ${product.price}</p>
                        <p><strong>Quantity:</strong> ${product.quantity}</p>
                        <p><strong>Category:</strong> ${product.category}</p>
                        ${product.description ? `<p><strong>Description:</strong> ${product.description}</p>` : ''}
                        <p><strong>Date Added:</strong> ${new Date(product.dateAdded).toLocaleString()}</p>
                        ${product.soldDate ? `<p><strong>Sold Date:</strong> ${new Date(product.soldDate).toLocaleString()}</p>` : ''}
                        ${product.soldDay ? `<p><strong>Sold Day:</strong> ${product.soldDay}</p>` : ''}
                        <p><strong>Status:</strong> <span class="badge badge-${product.status === 'sold' ? 'success' : product.status === 'outofstock' ? 'danger' : 'warning'}">${product.status.toUpperCase()}</span></p>
                    </div>
                `;
                
                modal.classList.add('active');
            }
        }

        function closeModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        function renderProductCard(product, showActions = true) {
            const statusBadge = product.status === 'sold' ? 'success' : 
                              product.status === 'outofstock' ? 'danger' : 'warning';
            
            // Format date as: Day Date/Month/Year
            let soldDateFormatted = '';
            if (product.soldDate) {
                const date = new Date(product.soldDate);
                const day = date.toLocaleDateString('en-US', { weekday: 'long' });
                const dateNum = date.getDate();
                const month = date.getMonth() + 1;
                const year = date.getFullYear();
                soldDateFormatted = `${day} ${dateNum}/${month}/${year}`;
            }
            
            return `
                <div class="product-card ${product.status === 'sold' ? 'sold' : ''} ${product.status === 'outofstock' ? 'out-of-stock' : ''}">
                    <div class="product-header">
                        <div class="product-title">${product.productName}</div>
                        <div class="product-price">PKR ${product.price}</div>
                    </div>
                    <div class="product-details">
                        <strong>Brand:</strong> ${product.brandName} | <strong>Model:</strong> ${product.modelNumber}<br>
                        <strong>Barcode:</strong> ${product.barcode}<br>
                        <strong>Category:</strong> ${product.category} | <strong>Quantity:</strong> ${product.quantity}<br>
                        ${product.soldDate ? `<strong>Sold:</strong> ${soldDateFormatted}<br>` : ''}
                        ${product.soldTime ? `<strong>Time:</strong> ${product.soldTime}<br>` : ''}
                        <span class="badge badge-${statusBadge}">${product.status.toUpperCase()}</span>
                    </div>
                    ${showActions ? `
                        <div class="product-actions">
                            ${product.status === 'available' ? `
                                <button class="btn btn-success" onclick="sellProduct('${product.barcode}')">üí∞ Sell</button>
                                <button class="btn btn-primary" onclick="openReceiptModal('${product.barcode}')">üìÑ Receipt</button>
                                <button class="btn btn-warning" onclick="markOutOfStock('${product.barcode}')">‚ùå Out of Stock</button>
                            ` : ''}
                            ${product.status === 'outofstock' ? `
                                <button class="btn btn-success" onclick="restockProduct('${product.barcode}')">üîÑ Restock</button>
                            ` : ''}
                            <button class="btn btn-primary" onclick="viewProductDetails('${product.barcode}')">üëÅÔ∏è View</button>
                            <button class="btn btn-danger" onclick="deleteProduct('${product.barcode}')">üóëÔ∏è Delete</button>
                        </div>
                    ` : `
                        <div class="product-actions">
                            <button class="btn btn-primary" onclick="viewSoldProductDetails('${product.barcode}', '${product.soldDate}')">üëÅÔ∏è View Product</button>
                        </div>
                    `}
                </div>
            `;
        }

        function renderAllLists() {
            // Available Stock
            const availableProducts = inventory.products.filter(p => p.status === 'available');
            const stockList = document.getElementById('stockList');
            if (availableProducts.length > 0) {
                stockList.innerHTML = availableProducts.map(p => renderProductCard(p)).join('');
            } else {
                stockList.innerHTML = '<div class="empty-state">üì¶ No products in stock</div>';
            }

            // Sold Items
            const soldList = document.getElementById('soldList');
            if (inventory.soldItems.length > 0) {
                soldList.innerHTML = inventory.soldItems.map(p => renderProductCard(p, false)).join('');
            } else {
                soldList.innerHTML = '<div class="empty-state">‚úÖ No sold items yet</div>';
            }

            // Out of Stock
            const outOfStockProducts = inventory.products.filter(p => p.status === 'outofstock');
            const outofstockList = document.getElementById('outofstockList');
            if (outOfStockProducts.length > 0) {
                outofstockList.innerHTML = outOfStockProducts.map(p => renderProductCard(p)).join('');
            } else {
                outofstockList.innerHTML = '<div class="empty-state">‚ùå No out of stock items</div>';
            }

            updateDashboard();
            updateAnalytics();
            renderReceipts();
        }

        function updateDashboard() {
            // Count only products that exist in inventory (not sold/deleted)
            const existingProducts = inventory.products.filter(p => p.status !== 'sold');
            
            document.getElementById('totalProducts').textContent = existingProducts.length;
            document.getElementById('availableStock').textContent = 
                inventory.products.filter(p => p.status === 'available').length;
            document.getElementById('soldItems').textContent = inventory.soldItems.length;
            document.getElementById('outOfStockItems').textContent = 
                inventory.products.filter(p => p.status === 'outofstock').length;

            // Recent Activity - Show last 10 sold items
            const recentActivity = document.getElementById('recentActivity');
            const recentSold = inventory.soldItems.slice(-10).reverse();
            
            if (recentSold.length > 0) {
                recentActivity.innerHTML = recentSold.map(item => {
                    const date = new Date(item.soldDate);
                    const day = date.toLocaleDateString('en-US', { weekday: 'long' });
                    const dateNum = date.getDate();
                    const month = date.getMonth() + 1;
                    const year = date.getFullYear();
                    const formattedDate = `${day} ${dateNum}/${month}/${year}`;
                    
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #2d5a8f; background: rgba(45, 90, 143, 0.1); margin-bottom: 8px; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong style="color: #4a9eff; font-size: 15px;">${item.productName}</strong><br>
                                    <span style="color: #b3d4f7; font-size: 13px;">${item.brandName} - ${item.modelNumber}</span><br>
                                    <span style="color: #28a745; font-weight: bold; font-size: 14px;">PKR ${item.price}</span>
                                </div>
                                <div style="text-align: right;">
                                    <span style="color: #b3d4f7; font-size: 12px;">${formattedDate}</span><br>
                                    <span style="color: #6c8ba3; font-size: 11px;">${item.soldTime}</span><br>
                                    <span class="badge badge-success" style="font-size: 10px; margin-top: 4px;">SOLD</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                recentActivity.innerHTML = '<div class="empty-state" style="padding: 30px;">üì≠ No recent activity<br><small style="color: #6c8ba3;">Sold items will appear here</small></div>';
            }
        }

        function updateAnalytics() {
            // Total Revenue
            const totalRevenue = inventory.soldItems.reduce((sum, item) => sum + item.price, 0);
            document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString();

            // Today's Sales
            const today = new Date().toDateString();
            const todaySales = inventory.soldItems.filter(item => 
                new Date(item.soldDate).toDateString() === today
            ).length;
            document.getElementById('todaySales').textContent = todaySales;

            // This Week's Sales
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekSales = inventory.soldItems.filter(item => 
                new Date(item.soldDate) >= weekAgo
            ).length;
            document.getElementById('weekSales').textContent = weekSales;

            // This Month's Sales
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            const monthSales = inventory.soldItems.filter(item => 
                new Date(item.soldDate) >= monthAgo
            ).length;
            document.getElementById('monthSales').textContent = monthSales;

            // Top Products
            const productSales = {};
            inventory.soldItems.forEach(item => {
                productSales[item.productName] = (productSales[item.productName] || 0) + 1;
            });
            
            const topProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const topProductsDiv = document.getElementById('topProducts');
            if (topProducts.length > 0) {
                topProductsDiv.innerHTML = topProducts.map(([name, count]) => `
                    <div class="product-details" style="padding: 10px; border-bottom: 1px solid #2d5a8f;">
                        <strong>${name}</strong> - ${count} sales
                    </div>
                `).join('');
            } else {
                topProductsDiv.innerHTML = '<div class="empty-state">No sales data yet</div>';
            }

            // Category Stats
            const categoryStats = {};
            inventory.products.forEach(item => {
                categoryStats[item.category] = (categoryStats[item.category] || 0) + 1;
            });
            
            const categoryStatsDiv = document.getElementById('categoryStats');
            if (Object.keys(categoryStats).length > 0) {
                categoryStatsDiv.innerHTML = Object.entries(categoryStats).map(([cat, count]) => `
                    <div class="product-details" style="padding: 10px; border-bottom: 1px solid #2d5a8f;">
                        <strong>${cat}:</strong> ${count} products
                    </div>
                `).join('');
            } else {
                categoryStatsDiv.innerHTML = '<div class="empty-state">No products yet</div>';
            }
        }

        function filterProducts(section) {
            const searchTerm = document.getElementById(`${section}Search`).value.toLowerCase();
            let products = [];
            
            if (section === 'stock') {
                products = inventory.products.filter(p => p.status === 'available');
            } else if (section === 'sold') {
                products = inventory.soldItems;
            } else if (section === 'outofstock') {
                products = inventory.products.filter(p => p.status === 'outofstock');
            }
            
            const filtered = products.filter(p => 
                p.productName.toLowerCase().includes(searchTerm) ||
                p.brandName.toLowerCase().includes(searchTerm) ||
                p.modelNumber.toLowerCase().includes(searchTerm) ||
                p.barcode.toLowerCase().includes(searchTerm)
            );
            
            const listDiv = document.getElementById(`${section}List`);
            if (filtered.length > 0) {
                listDiv.innerHTML = filtered.map(p => renderProductCard(p, section !== 'sold')).join('');
            } else {
                listDiv.innerHTML = '<div class="empty-state">No matching products found</div>';
            }
        }

        function filterByCategory(section, category) {
            // Update active button
            event.target.parentElement.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            let products = inventory.products.filter(p => p.status === 'available');
            
            if (category !== 'all') {
                products = products.filter(p => p.category === category);
            }
            
            const listDiv = document.getElementById(`${section}List`);
            if (products.length > 0) {
                listDiv.innerHTML = products.map(p => renderProductCard(p)).join('');
            } else {
                listDiv.innerHTML = '<div class="empty-state">No products in this category</div>';
            }
        }

        function filterByDate(section, period) {
            // Update active button
            event.target.parentElement.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            let products = inventory.soldItems;
            const now = new Date();
            
            if (period === 'today') {
                products = products.filter(p => 
                    new Date(p.soldDate).toDateString() === now.toDateString()
                );
            } else if (period === 'week') {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                products = products.filter(p => new Date(p.soldDate) >= weekAgo);
            } else if (period === 'month') {
                const monthAgo = new Date();
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                products = products.filter(p => new Date(p.soldDate) >= monthAgo);
            }
            
            const listDiv = document.getElementById(`${section}List`);
            if (products.length > 0) {
                listDiv.innerHTML = products.map(p => renderProductCard(p, false)).join('');
            } else {
                listDiv.innerHTML = '<div class="empty-state">No items found for this period</div>';
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(inventory, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `inventory_backup_${Date.now()}.json`;
            link.click();
            alert('‚úÖ Data exported successfully!');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        inventory = JSON.parse(event.target.result);
                        saveData();
                        renderAllLists();
                        alert('‚úÖ Data imported successfully!');
                    } catch (error) {
                        alert('‚ùå Invalid file format!');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function resetApp() {
            const confirmation = confirm('‚ö†Ô∏è WARNING: This will delete ALL data from the app!\n\n' +
                'This includes:\n' +
                '- All Products\n' +
                '- All Sold Items\n' +
                '- All History\n' +
                '- All Analytics\n\n' +
                'This action CANNOT be undone!\n\n' +
                'Are you absolutely sure you want to reset the app?');
            
            if (confirmation) {
                const doubleConfirm = confirm('‚ö†Ô∏è FINAL WARNING!\n\n' +
                    'This is your last chance to cancel.\n\n' +
                    'Click OK to DELETE ALL DATA permanently.\n' +
                    'Click Cancel to keep your data safe.');
                
                if (doubleConfirm) {
                    // Clear all data
                    inventory = {
                        products: [],
                        soldItems: [],
                        receipts: [],
                        currentBarcode: null
                    };
                    
                    // Clear localStorage
                    localStorage.removeItem('inventoryData');
                    
                    // Reset display
                    renderAllLists();
                    updateDashboard();
                    
                    // Show success message
                    alert('‚úÖ App has been reset successfully!\n\nAll data has been deleted.');
                    
                    // Redirect to dashboard
                    switchTab('dashboard');
                }
            }
        }

        function renderReceipts() {
            const receiptsList = document.getElementById('receiptsList');
            if (!receiptsList) return;
            
            const receipts = inventory.receipts || [];
            
            if (receipts.length > 0) {
                receiptsList.innerHTML = receipts.slice().reverse().map(receipt => `
                    <div class="product-card" style="border-left-color: #4a9eff;">
                        <div class="product-header">
                            <div class="product-title">Receipt #${receipt.receiptNumber}</div>
                            <div class="product-price">PKR ${receipt.product.price}</div>
                        </div>
                        <div class="product-details">
                            <strong>Customer:</strong> ${receipt.customerName}<br>
                            ${receipt.customerPhone ? `<strong>Phone:</strong> ${receipt.customerPhone}<br>` : ''}
                            <strong>Product:</strong> ${receipt.product.productName}<br>
                            <strong>Date:</strong> ${receipt.formattedDate}<br>
                            <strong>Time:</strong> ${receipt.time}<br>
                            ${receipt.paymentMethod ? `<strong>Payment:</strong> ${receipt.paymentMethod}<br>` : ''}
                            <span class="badge badge-success">RECEIPT</span>
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-primary" onclick="viewReceiptDetails('${receipt.receiptNumber}', ${receipt.createdAt})">üëÅÔ∏è View Receipt</button>
                            <button class="btn btn-danger" onclick="deleteReceipt('${receipt.receiptNumber}', ${receipt.createdAt})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `).join('');
            } else {
                receiptsList.innerHTML = '<div class="empty-state">üìÑ No receipts created yet</div>';
            }
        }

        function filterReceipts() {
            const searchTerm = document.getElementById('receiptsSearch').value.toLowerCase();
            const receipts = inventory.receipts || [];
            
            const filtered = receipts.filter(r => 
                (r.receiptNumber && r.receiptNumber.toLowerCase().includes(searchTerm)) ||
                (r.customerName && r.customerName.toLowerCase().includes(searchTerm)) ||
                (r.product && r.product.productName && r.product.productName.toLowerCase().includes(searchTerm)) ||
                (r.product && r.product.brandName && r.product.brandName.toLowerCase().includes(searchTerm)) ||
                (r.customerPhone && r.customerPhone.toLowerCase().includes(searchTerm))
            );
            
            const receiptsList = document.getElementById('receiptsList');
            if (filtered.length > 0) {
                receiptsList.innerHTML = filtered.slice().reverse().map(receipt => `
                    <div class="product-card" style="border-left-color: #4a9eff;">
                        <div class="product-header">
                            <div class="product-title">Receipt #${receipt.receiptNumber}</div>
                            <div class="product-price">PKR ${receipt.product.price}</div>
                        </div>
                        <div class="product-details">
                            <strong>Customer:</strong> ${receipt.customerName}<br>
                            ${receipt.customerPhone ? `<strong>Phone:</strong> ${receipt.customerPhone}<br>` : ''}
                            <strong>Product:</strong> ${receipt.product.productName}<br>
                            <strong>Date:</strong> ${receipt.formattedDate}<br>
                            <strong>Time:</strong> ${receipt.time}<br>
                            ${receipt.paymentMethod ? `<strong>Payment:</strong> ${receipt.paymentMethod}<br>` : ''}
                            <span class="badge badge-success">RECEIPT</span>
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-primary" onclick="viewReceiptDetails('${receipt.receiptNumber}', ${receipt.createdAt})">üëÅÔ∏è View Receipt</button>
                            <button class="btn btn-danger" onclick="deleteReceipt('${receipt.receiptNumber}', ${receipt.createdAt})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `).join('');
            } else {
                receiptsList.innerHTML = '<div class="empty-state">üîç No matching receipts found</div>';
            }
        }

        function filterReceiptsByDate(period) {
            // Update active button
            event.target.parentElement.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            const receipts = inventory.receipts || [];
            const now = new Date();
            let filtered = receipts;
            
            if (period === 'today') {
                filtered = receipts.filter(r => 
                    new Date(r.date).toDateString() === now.toDateString()
                );
            } else if (period === 'week') {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                filtered = receipts.filter(r => new Date(r.date) >= weekAgo);
            } else if (period === 'month') {
                const monthAgo = new Date();
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                filtered = receipts.filter(r => new Date(r.date) >= monthAgo);
            }
            
            const receiptsList = document.getElementById('receiptsList');
            if (filtered.length > 0) {
                receiptsList.innerHTML = filtered.slice().reverse().map(receipt => `
                    <div class="product-card" style="border-left-color: #4a9eff;">
                        <div class="product-header">
                            <div class="product-title">Receipt #${receipt.receiptNumber}</div>
                            <div class="product-price">PKR ${receipt.product.price}</div>
                        </div>
                        <div class="product-details">
                            <strong>Customer:</strong> ${receipt.customerName}<br>
                            ${receipt.customerPhone ? `<strong>Phone:</strong> ${receipt.customerPhone}<br>` : ''}
                            <strong>Product:</strong> ${receipt.product.productName}<br>
                            <strong>Date:</strong> ${receipt.formattedDate}<br>
                            <strong>Time:</strong> ${receipt.time}<br>
                            ${receipt.paymentMethod ? `<strong>Payment:</strong> ${receipt.paymentMethod}<br>` : ''}
                            <span class="badge badge-success">RECEIPT</span>
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-primary" onclick="viewReceiptDetails('${receipt.receiptNumber}', ${receipt.createdAt})">üëÅÔ∏è View Receipt</button>
                            <button class="btn btn-danger" onclick="deleteReceipt('${receipt.receiptNumber}', ${receipt.createdAt})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `).join('');
            } else {
                receiptsList.innerHTML = '<div class="empty-state">üìÑ No receipts found for this period</div>';
            }
        }

        function viewReceiptDetails(receiptNumber, createdAt) {
            const receipt = inventory.receipts.find(r => r.receiptNumber === receiptNumber && r.createdAt === createdAt);
            
            if (receipt) {
                const modal = document.getElementById('productModal');
                const details = document.getElementById('modalProductDetails');
                
                details.innerHTML = `
                    <div class="product-card">
                        <h3>üìÑ Receipt Details</h3>
                        <div style="margin: 15px 0; padding: 15px; background: #f0f0f0; border-radius: 8px;">
                            <p><strong>Receipt Number:</strong> ${receipt.receiptNumber}</p>
                            <p><strong>Date:</strong> ${receipt.formattedDate}</p>
                            <p><strong>Time:</strong> ${receipt.time}</p>
                        </div>
                        
                        <h4 style="margin-top: 20px; color: #4a9eff;">Customer Information</h4>
                        <p><strong>Name:</strong> ${receipt.customerName}</p>
                        ${receipt.customerPhone ? `<p><strong>Phone:</strong> ${receipt.customerPhone}</p>` : ''}
                        ${receipt.customerAddress ? `<p><strong>Address:</strong> ${receipt.customerAddress}</p>` : ''}
                        
                        <h4 style="margin-top: 20px; color: #4a9eff;">Product Information</h4>
                        <p><strong>Product Name:</strong> ${receipt.product.productName}</p>
                        <p><strong>Brand:</strong> ${receipt.product.brandName}</p>
                        <p><strong>Model Number:</strong> ${receipt.product.modelNumber}</p>
                        <p><strong>Barcode:</strong> ${receipt.product.barcode}</p>
                        <p><strong>Category:</strong> ${receipt.product.category}</p>
                        
                        <h4 style="margin-top: 20px; color: #4a9eff;">Payment Information</h4>
                        <p><strong>Amount:</strong> <span style="color: #28a745; font-size: 20px; font-weight: bold;">PKR ${receipt.product.price}</span></p>
                        ${receipt.paymentMethod ? `<p><strong>Payment Method:</strong> ${receipt.paymentMethod}</p>` : ''}
                        
                        ${receipt.receiptNotes ? `
                        <h4 style="margin-top: 20px; color: #4a9eff;">Notes</h4>
                        <p>${receipt.receiptNotes}</p>
                        ` : ''}
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #2d5a8f;">
                            <button class="btn btn-danger" onclick="deleteReceipt('${receipt.receiptNumber}', ${receipt.createdAt}); closeModal();" style="width: 100%;">
                                üóëÔ∏è Delete This Receipt
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.add('active');
            }
        }

        function deleteReceipt(receiptNumber, createdAt) {
            if (confirm('‚ö†Ô∏è Are you sure you want to delete this receipt?\n\nReceipt #: ' + receiptNumber)) {
                const index = inventory.receipts.findIndex(r => r.receiptNumber === receiptNumber && r.createdAt === createdAt);
                
                if (index !== -1) {
                    inventory.receipts.splice(index, 1);
                    saveData();
                    renderReceipts();
                    alert('‚úÖ Receipt deleted successfully!');
                } else {
                    alert('‚ùå Receipt not found!');
                }
            }
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Make button active
            event.target.classList.add('active');
            
            // Stop scanner if switching away from scan tab
            if (tabName !== 'scan' && html5QrCode) {
                stopScanner();
            }
        }

        let currentReceiptProduct = null;

        function openReceiptModal(barcode) {
            const product = inventory.products.find(p => p.barcode === barcode && p.status === 'available');
            if (product) {
                currentReceiptProduct = product;
                document.getElementById('receiptModal').classList.add('active');
                document.getElementById('receiptForm').style.display = 'block';
                document.getElementById('receiptPreview').style.display = 'none';
                document.getElementById('receiptForm').reset();
            }
        }

        function closeReceiptModal() {
            document.getElementById('receiptModal').classList.remove('active');
            currentReceiptProduct = null;
        }

        function resetReceiptForm() {
            document.getElementById('receiptForm').style.display = 'block';
            document.getElementById('receiptPreview').style.display = 'none';
            document.getElementById('receiptForm').reset();
        }

        document.getElementById('receiptForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!currentReceiptProduct) return;

            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const customerAddress = document.getElementById('customerAddress').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const receiptNotes = document.getElementById('receiptNotes').value;
            const customReceiptNumber = document.getElementById('receiptNumber').value;

            const now = new Date();
            const receiptDate = now.toLocaleDateString('en-US', { weekday: 'long' }) + ' ' + 
                               now.getDate() + '/' + (now.getMonth() + 1) + '/' + now.getFullYear();
            const receiptTime = now.toLocaleTimeString();
            const receiptNumber = customReceiptNumber || 'RCP' + Date.now();

            const receiptHTML = `
                <div class="receipt-header">
                    <h2>üì¶ INVOICE</h2>
                    <p style="margin: 5px 0;">Inventory Manager Pro</p>
                    <p style="margin: 5px 0; font-size: 12px;">Receipt #: ${receiptNumber}</p>
                </div>
                
                <div style="margin: 15px 0;">
                    <strong>Date:</strong> ${receiptDate}<br>
                    <strong>Time:</strong> ${receiptTime}
                </div>

                <div style="border-top: 1px solid #000; border-bottom: 1px solid #000; padding: 10px 0; margin: 15px 0;">
                    <strong>CUSTOMER DETAILS</strong><br>
                    <strong>Name:</strong> ${customerName}<br>
                    ${customerPhone ? `<strong>Phone:</strong> ${customerPhone}<br>` : ''}
                    ${customerAddress ? `<strong>Address:</strong> ${customerAddress}<br>` : ''}
                </div>

                <div style="margin: 15px 0;">
                    <strong>PRODUCT DETAILS</strong><br>
                    <div style="margin-top: 10px;">
                        <div class="receipt-row">
                            <span>Product:</span>
                            <span>${currentReceiptProduct.productName}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Brand:</span>
                            <span>${currentReceiptProduct.brandName}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Model:</span>
                            <span>${currentReceiptProduct.modelNumber}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Barcode ID:</span>
                            <span style="font-weight: bold; color: #333;">${currentReceiptProduct.barcode}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Category:</span>
                            <span>${currentReceiptProduct.category}</span>
                        </div>
                        <div class="receipt-row">
                            <span>Quantity:</span>
                            <span>1</span>
                        </div>
                    </div>
                </div>

                ${paymentMethod ? `
                <div style="margin: 15px 0;">
                    <div class="receipt-row">
                        <span><strong>Payment Method:</strong></span>
                        <span>${paymentMethod}</span>
                    </div>
                </div>
                ` : ''}

                <div style="border-top: 2px solid #000; margin: 15px 0; padding-top: 10px;">
                    <div class="receipt-row receipt-total">
                        <span>TOTAL AMOUNT:</span>
                        <span>PKR ${currentReceiptProduct.price}</span>
                    </div>
                </div>

                ${receiptNotes ? `
                <div style="margin: 15px 0; font-size: 12px;">
                    <strong>Notes:</strong><br>
                    ${receiptNotes}
                </div>
                ` : ''}

                <div class="receipt-footer">
                    <p>Thank you for your business!</p>
                    <p style="margin-top: 10px;">This is a computer generated receipt</p>
                    <p style="margin-top: 5px; font-size: 10px;">Powered by Inventory Manager Pro</p>
                </div>
            `;

            document.getElementById('receiptContent').innerHTML = receiptHTML;
            
            // Save receipt to receipts array
            const receiptData = {
                receiptNumber: receiptNumber,
                customerName: customerName,
                customerPhone: customerPhone,
                customerAddress: customerAddress,
                paymentMethod: paymentMethod,
                receiptNotes: receiptNotes,
                product: {
                    barcode: currentReceiptProduct.barcode,
                    productName: currentReceiptProduct.productName,
                    brandName: currentReceiptProduct.brandName,
                    modelNumber: currentReceiptProduct.modelNumber,
                    category: currentReceiptProduct.category,
                    price: currentReceiptProduct.price
                },
                date: now.toISOString(),
                formattedDate: receiptDate,
                time: receiptTime,
                createdAt: Date.now()
            };
            
            // Ensure receipts array exists
            if (!inventory.receipts) {
                inventory.receipts = [];
            }
            
            inventory.receipts.push(receiptData);
            saveData();
            
            document.getElementById('receiptForm').style.display = 'none';
            document.getElementById('receiptPreview').style.display = 'block';

            // Now sell the product
            sellProduct(currentReceiptProduct.barcode);
        });

        function printReceipt() {
            window.print();
        }

        function downloadReceipt() {
            const receiptContent = document.getElementById('receiptContent');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = 800;
            canvas.height = 1200;
            
            // Fill white background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw receipt text
            ctx.fillStyle = 'black';
            ctx.font = '14px Courier New';
            
            const lines = receiptContent.innerText.split('\n');
            let y = 50;
            lines.forEach(line => {
                ctx.fillText(line, 50, y);
                y += 20;
            });
            
            // Download as image
            const link = document.createElement('a');
            link.download = `receipt_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            alert('‚úÖ Receipt downloaded successfully!');
        }

        // Initialize app
        loadData();
    </script>
</body>
</html>